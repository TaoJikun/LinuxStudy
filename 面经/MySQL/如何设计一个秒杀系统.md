[TOC]

# 秒杀问题需要考虑哪些问题

## 1 超卖问题

不能存量100的货物最终卖出去200个

## 2 高并发

短时间内有很大量的请求涌入，不能造成系统崩溃，例如oom，数据库失效等

## 3 接口防刷

防止重复的请求，刷单的请求，恶意的请求

## 4 秒杀的地址

前端可能是按钮不能被点击的，但是有可能通过查看源代码的方式发现秒杀的地址。

## 5 数据库设计

如果跟其他业务在一起，有可能会影响到其他业务

## 6 大量请求问题

如果使用缓存，加入使用的是redis缓存，可能还是会被缓存击穿，然后请求进入到db，mysql会崩溃。

# 秒杀系统的设计和实现方案

## 秒杀数据库的设计

因为第五个问题提出的，如果mysql的负荷比较大，那么就会对其他业务产生影响，所以可以重新设计一个数据库，专门负责这个产品的秒杀的业务。

这里需要两张表：

- 秒杀订单表
  - 订单id
  - 订单时间
  - 订单价格
  - 用户id
  - 订单数量
  - 货物id
  - 是否付款
  - 到期时间
- 秒杀货物表
  - 货物名称 varchar
  - 货物id varchar(11)
  - 货物价格 int
  - 货物秒杀价 int
  - 货物原价 int
  - 货物库存 int

## 秒杀url的设计

应该给出动态的地址，不应该写死。

可以在秒杀开始之前，让这个地址没有生成，然后秒杀开始后，通过时间和hash算法或者md5算法，生成一个网址，然后将这个网址动态的发送到页面上去。

可以通过ajax异步刷新等方式，获取新的网址。

## 秒杀页面静态话

就是说付款页面有一个确定页面嘛，这个页面最好是前端生成的，而不是有后端查询数据库产生的参数返回给前端，可可以通过freemaker，发送一个【带有参数的】html，然后前端去渲染

## 避免秒杀程序：

应该可以增加一些点击验证码啊这一类的验证模块，然后让跟标准的北京时间有一个差距，

## 使用nginx

使用nginx可以增大并发能力，tomcat可能并发量只有几百，nginx是一个占用内存小，并发能力强的http反向代理服务器

## redis预减库存

## 接口限流

接口限流有很多种方式，秒杀系统最终是数据库的更新，所以可以通过限流的方式来解决无效的请求，

### 前端限流

就是防止重复发起请求嘛，点击之后，再接下来的一段时间内比如10s内无法发起请求，按钮时灰的这样的

### 重复请求限流

通过redis来过滤重复的请求，对userid设定一个过期的时间。具体的做法就是通过redis的键过期策略，首先对每个请求都从  String value = redis.get(userId)  ;
如果获取到这个  value为空或者为null，表示它是有效的请求，然后放行这个请求。如果不为空表示它是重复性请求，直接丢掉这个请求。
如果有效，采用  redis.setexpire(userId,value,10).value

### 令牌桶算法限流

就是最终来到后台的请求并不一定都有效，我们可以从中给请求发放令牌，只有拥有令牌的请求才是有效的。



## 异步请求

对于有效的请求，可以将它们放到队列中。可以采用消息队列，可以采用rabbitmq来进行

### 消息队列

消息队列是只的是在应用中传递数据，消息可能有多种类型，消息队列是一种在应用之间传递消息的通信方式，消息发送后立即返回，消息发布者只管将消息放到消息队列中，而不管谁去取。而消息使用者就会不管这个消息是谁发送的，而只管着去取用数据。

### 为什么需要消息队列

就拿这个例子举例来说，如果说是下订单，可能有很多流程，验证库存，扣除库存，生成订单，发送通知等流程，位了减少主流程减轻负担，可以讲发送通知着一些的动作放到消息队列当中。

## 服务降级

如果在秒杀过程中出现了异常，例如某个服务器宕机了，或者出现服务出错了的情况，要及时的通知用户而不是诶卡在页面当中。

可以通过Hystrix进行服务熔断和降级，可以开发一个备用服务。

<https://mp.weixin.qq.com/s/2n73YSoXPoPpYQSxuFwCOQ>